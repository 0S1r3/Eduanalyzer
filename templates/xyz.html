<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <!-- Socket.io JS-->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
    <!-- Sortable JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- ECharts + ECharts-GL для 3D -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>


    <!-- DataTables core -->
    <link rel="stylesheet" 
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.6.2/js/dataTables.select.min.js"></script>

    <!-- Buttons extension -->
    <link rel="stylesheet" 
    href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>

    <!-- Зависимости для HTML5-экспорта -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <!-- Собственно кнопки экспорта -->
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>

    <script src="js/selectors.js" defer type="module"></script>

    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/profile.css">
    <script src="js/scripts.js" defer type="module"></script>
    <script src="js/profile.js" defer></script>
    <script src="js/photo.js" defer></script>
    <title>XYZ-анализ успеваемости и посещаемости</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
</head>

<body>
    <div class="header">
        <div class="profile-container">
            <div class="profile-icon" id="profileIcon">
                <img id="userPhoto" alt="Профиль" />
            </div>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="{{ url_for('profile') }}" class="dropdown-button">Профиль</a>
                <a href="{{ url_for('logout') }}" class="dropdown-button">Выход</a>
            </div>
        </div>

        <img src="/static/favicon.png" alt="Логотип" class="header-logo" />
        <a href="/main">Главная</a>
    </div>

    <h1 style="text-align: center; font-family: Arial, sans-serif;">Загрузка данных учеников</h1>

    <div class="tabs">
        <div class="tab active" onclick="openTab(event, 'uploadStudents')">Загрузка списка учеников</div>
        <div class="tab" onclick="openTab(event, 'uploadExcel')">Загрузка Excel</div>
        <div class="tab" onclick="openTab(event, 'uploadPhotos')">Загрузка фото</div>
    </div>

    <!-- Содержимое вкладок -->
    <div id="uploadStudents" class="tab-content active">
        <!-- Загрузка данных из Базы данных -->
        <div class="container">
            <h2>Загрузка данных учеников</h2>
            <form id="filter-form-no-selector-graph">
                <div class="filter-row">
                    <select id="classSelect">
                        <option value="">Выберите класс</option>
                        <!-- Динамически заполняемые классы -->
                    </select>
                </div>
                <div class="filter-row">
                    <select id="classLetterSelect">
                        <option value="">Выберите букву класса</option>
                        <!-- Динамически заполняемые буквы классов -->
                    </select>
                </div>
                <div class="filter-row">
                    <select id="subjectSelect">
                        <option value="">Выберите предмет</option>
                        <!-- Динамически заполняемые предметы -->
                    </select>
                </div>
                <div class="filter-row">
                    <select id="teacherSelect">
                        <option value="">Выберите преподавателя</option>
                        <!-- Динамически заполняемые преподаватели -->
                    </select>
                </div>
                <div class="filter-row">
                    <select id="performanceSelect">
                        <option value="grades">Успеваемость</option>
                        <option value="attendance">Посещаемость</option>
                    </select>
                </div>
                <div class="filter-row">
                    <select id="periodSelect">
                        <option value="">Выберите период</option>
                        <!-- Динамически заполняемые периоды -->
                    </select>
                </div>
                <div class="filter-row">
                    <select id="periodSelectYear">
                        <option value="">Выберите год обучения</option>
                        <!-- Динамически заполняемые года обучения -->
                    </select>
                </div>
                <button type="button" onclick="loadData()">Загрузить данные</button>
            </form>
        </div>    
    </div>

    <div id="uploadExcel" class="tab-content">
        <!-- Загрузка данных из Excel -->
        <div class="containerForUpload">
            <h2>Загрузка Excel</h2>
            <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
                <div class="upload-area" id="uploadArea">
                    <img src="/static/upload.png" alt="Upload Icon" width="50">
                    <p>Перетащите файлы сюда</p>
                    <label for="fileInput" style="cursor: pointer; color: #007bff;">Выберите файл</label>
                    <input type="file" id="fileInput" style="display: none;">
                </div>
                <button class="start-button">Загрузить файл Excel</button>
            </form>
        </div>
    </div>

    <div id="uploadPhotos" class="tab-content">
        <!-- Загрузка данных по фото аудитории (класса) -->
        <div class="containerForUploadPhotos">
            <h2>Загрузка фотографий</h2>
            
            <form id="photoUploadForm" action="/upload_photos" method="post" enctype="multipart/form-data">
                <!-- Выбор предмета -->
                <div class="form-group styled-select">
                    <label for="subjectSelectPhoto">Выберите предмет:</label>
                    <select id="subjectSelectPhoto" name="subject" required>
                        <option value="" disabled selected>Выберите предмет</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id_subject }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>
        
                <!-- Выбор класса -->
                <div class="form-group styled-select">
                    <label for="classSelectPhoto">Выберите класс:</label>
                    <select id="classSelectPhoto" name="class_name" required>
                        <option value="" disabled selected>Выберите класс</option>
                        {% for class_number, class_letter in classes %}
                        <option value="{{ class_number }} {{ class_letter }}">{{ class_number }} {{ class_letter }}</option>
                        {% endfor %}
                    </select>
                </div>
        
                <!-- Календарь выбора нескольких дат -->
                <div class="calendar-wrapper">
                    <label for="calendarInput">Выберите даты:</label>
                    <div id="calendarInput"></div>
                    <div id="selectedDatesList" class="selected-dates-list"></div>
                </div>
                
        
                <!-- Область для загрузки фотографий -->
                <div id="photoUploadArea">
                    <img src="/static/upload_photo.png" alt="Upload Icon" width="50">
                    <p>Перетащите фото сюда</p>
                    <label for="photoInput" class="photo-input-label" style="cursor: pointer; color: #007bff;">Выберите фото</label>
                    <input type="file" id="photoInput" name="photos" multiple style="display: none;">
                </div>
        
                <!-- Контейнер для превью фотографий -->
                <div id="photoPreviewContainer" class="photo-preview-container">
                    <!-- Миниатюры загруженных фото будут добавлены сюда -->
                </div>

                <!-- Кнопка "Удалить все фото" -->
                <button id="deleteAllButton" class="delete-all-button hide" type="button">Удалить все фото</button>
        
                <!-- Кнопка загрузки -->
                <button class="upload-button" type="submit">Загрузить фото</button>

                <!-- Отображение распознавания в реальном времени -->
                <div id="realTimeDisplay" class="real-time-display">
                    <h3>Процесс обработки</h3>
                    <div class="progress-bar">
                        <div id="progressText" class="progress-text">Обработано фото 0 из 0</div>
                        <div id="progressBarFill" class="progress-bar-fill"></div>
                    </div>
                    <!-- Метка текущей фотографии -->
                    <div id="photoCounter" class="photo-counter">Фото 0 из 0</div>
                    <div id="photoCarousel" class="photo-carousel">
                        <button class="carousel-button prev" id="prevPhoto" type="button">&lt;</button>
                        <img id="currentPhoto" src="/static/placeholder.jpeg" alt="Превью фото" class="carousel-image">
                        <button class="carousel-button next" id="nextPhoto" type="button">&gt;</button>
                    </div>
                    <!-- Кнопка сворачивания текстовой информации -->
                    <button id="toggleInfo" class="toggle-info-button" type="button">Показать информацию</button>
                    <div id="processedPhotos" class="processed-photos" style="display: none;">
                        <!-- Информация о распознанных студентах -->
                    </div>
                </div>


                
            </form>
        </div>
    </div>

    <div class="containerTable" style="display: none;">
        <table id="studentTable">
            <thead>
                <!-- Headers will be dynamically populated here -->
            </thead>
            <tbody>
                <!-- Data will be dynamically populated here -->
            </tbody>
        </table>
        <button onclick="analyzeXYZData()">Выполнить XYZ-анализ</button>
    </div>

    <button id="settingsBtn" class="settings-btn">
        <img src="/static/settings.png">
        <i class="fas fa-cog"></i>
    </button>
    <div id="settingsMenu" class="settings-menu">
        <h2>Настройки XYZ-анализа</h2>
        <div class="slider-container">
            <label for="analysisType">Тип анализа:</label>
            <select id="analysisType">
                <option value="attendance">Посещаемость</option>
                <option value="performance">Успеваемость</option>
            </select>
        </div>

        <div class="slider-container">
            <label for="startQuarter">Начальный период:</label>
            <select id="startQuarter">
            </select>
        </div>
        
        <!-- Dropdown for selecting end quarter -->
        <div class="slider-container">
            <label for="endQuarter">Конечный период:</label>
            <select id="endQuarter">
            </select>
        </div>

        <script src="js/dropdownStartEnd.js"></script>

        <!-- Slider for category X threshold -->
        <div class="slider-container">
            <label for="thresholdX">Порог категории X:</label>
            <input type="range" id="thresholdX" min="0" max="100" value="10"
                oninput="updateThresholdValue('thresholdX', 'thresholdXValue')">
            <span id="thresholdXValue">10%</span>
        </div>

        <!-- Slider for category Y threshold -->
        <div class="slider-container">
            <label for="thresholdY">Порог категории Y:</label>
            <input type="range" id="thresholdY" min="0" max="100" value="25"
                oninput="updateThresholdValue('thresholdY', 'thresholdYValue')">
            <span id="thresholdYValue">25%</span>
        </div>

        <!-- Slider for category Z threshold -->
        <div class="slider-container">
            <label for="thresholdZ">Порог категории Z:</label>
            <input type="range" id="thresholdZ" min="0" max="100" value="65"
                oninput="updateThresholdValue('thresholdZ', 'thresholdZValue')">
            <span id="thresholdZValue">65%</span>
        </div>
    </div>

    <h1 id="analysisHeader" style="display: none;">XYZ-анализ успеваемости</h1>
    <div class="container-centered">
            <!-- Карточки-метрики -->
        <div id="metricsCards" class="metrics-cards" style="display:none;">
            <div class="card">
            <div class="card-title">Всего учеников</div>
            <div class="card-value" id="totalCount">–</div>
            </div>
            <div class="card" style="background-color: #00ff00;">
            <div class="card-title">Категория X</div>
            <div class="card-value" id="countX">–</div>
            </div>
            <div class="card" style="background-color: #f6ff00;">
            <div class="card-title">Категория Y</div>
            <div class="card-value" id="countY">–</div>
            </div>
            <div class="card" style="background-color: #ff0000;">
            <div class="card-title">Категория Z</div>
            <div class="card-value" id="countZ">–</div>
            </div>
        </div>

        <!-- 2. Таблица результатов -->
        <details open style="display:none;">
            <summary>Таблица XYZ-анализа</summary>
            <div style="overflow-x:auto;">
            <table id="resTable" class="styled-table" style="width:100%;">
                <thead></thead>
                <tbody></tbody>
            </table>
            </div>
        </details>

        <!-- 3. Гистограмма -->
        <details open style="display:none;">
            <summary>Распределение учащихся по группам</summary>
            <div id="chart_histogram" style="width:100%; height:700px;"></div>
        </details>
        
        <!-- Круговая диаграмма -->
        <details open style="display:none;">
            <summary>Соотношение учащихся по группам</summary>
            <div id="chart_pie3d" style="width:100%; height:700px;"></div>
        </details>    
        
        <!-- Контекстное меню -->
        <div id="category-menu">
            <!-- ручная -->
            <div class="menu-section section-manual">Ручная замена:</div>
            <ul class="submenu section-manual">
            <li class="menu-item manual" data-cat="X">X</li>
            <li class="menu-item manual" data-cat="Y">Y</li>
            <li class="menu-item manual" data-cat="Z">Z</li>
            </ul>
        
            <!-- автоклассификация -->
            <div class="menu-section section-auto">Автоклассификация:</div>
            <ul class="submenu section-auto">
            <li class="menu-item auto one" data-method="avgAbsence">По среднему значению (выбранные)</li>
            <li class="menu-item auto all" data-method="avgAbsence">По среднему значению (все)</li>
            <li class="menu-item auto one" data-method="sumAbsence">По сумме (выбранные)</li>
            <li class="menu-item auto all" data-method="sumAbsence">По сумме (все)</li>
            <li style="margin:6px 0;">
                Мин. порог: <input type="number" id="ctx-minAllowed" value="0" min="0" style="width:50px">
            </li>
            <li style="margin:6px 0;">
                Макс. порог: <input type="number" id="ctx-maxAllowed" value="5" min="0" style="width:50px">
            </li>
            <li class="menu-item auto one" data-method="allowed">По предельно-допустимым порогам (выбранные)</li>
            <li class="menu-item auto all" data-method="allowed">По предельно-допустимым порогам (все)</li>
            </ul>
        
            <!-- футер с кнопками -->
            <div class="menu-footer">
            <button class="btn-reset">Сбросить</button>
            </div>
        </div>

        <ul id="period-menu" class="period-menu">
            <!-- Кнопка закрытия -->
            <li class="close-period-menu" title="Закрыть меню">✕</li>
            <li data-action="outlier">Автозамена выброса на среднее</li>
            <li data-action="reset">Сбросить к исходному</li>
          </ul>
          
  
        
        <!-- НЕЗАВИСИМЫЕ ДИАГРАММЫ -->

        <form id="filters-form" style="display:none;">
            <h2>Динамика учеников</h2>
            <!-- 5. Ученик -->
            <div class="filter-row">
                <label for="student">Ученик:</label>
                <select id="student" name="student_id" disabled>
                <option value="">— сначала учитель —</option>
                </select>
            </div>
        
            <!-- 8. Период (статичный) -->
            <div class="filter-row">
                <label for="period">Период:</label>
                <select id="period" name="period_type">
                <option value="quarter">По четвертям</option>
                <option value="month">По месяцам</option>
                </select>
            </div>
        
            <button type="submit">Показать динамику по выбранному ученику</button>
        </form>

        <!-- 5. Динамика принадлежности ученика к группе -->
        <details open style="display:none;">
            <summary>Динамика принадлежности ученика к группе</summary>

            <div id="chart_membership_dynamic" style="width:100%; height:700px;"></div>
        </details>
        
        <!-- 6. Столбчатая диаграмма распределения по периодам -->
        <details open style="display:none;">
            <summary>Распределение количества учеников по категориям</summary>
            <div id="chart_distribution_bar" style="width:100%; height:700px;"></div>
        </details>
        
        <!-- 7. Динамика пороговых баллов -->
        <details open style="display:none;">
            <summary>Динамика порогового балла в группах</summary>
            <div id="chart_threshold_dynamic" style="width:100%; height:700px;"></div>
        </details>
    </div>

    <div id="recommendations" style="display: none;">
        <h2>Рекомендации по группам XYZ-анализа:</h2>
        <p><strong class="group-A">Группа X:</strong> Ученики с высокими показателями, которые могут требовать дополнительных вызовов и задач для удержания их заинтересованности и продвижения вперед.</p>
        <p><strong class="group-B">Группа Y:</strong> Ученики с средними показателями, которые нуждаются в некоторой поддержке и стимуле для улучшения своих результатов.</p>
        <p><strong class="group-C">Группа Z:</strong> Ученики с низкими показателями, которым требуется индивидуальный подход и дополнительные усилия для достижения учебных целей.</p>
    </div>
    
</body>

</html>